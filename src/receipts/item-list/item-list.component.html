<div class="item-list-container">

  <!-- Instant Inline Add Form -->
  @if (isAdding) {
    <div class="inline-add-form" #addForm>
      <app-card cardStyle="w-100 mb-2 add-form-card">
        <div content>
          <div class="row g-0 add-form-fields">
            <app-input
              #nameInput
              label="Name"
              class="col"
              [inputFormControl]="newItemFormGroup | formGet : 'name'"
              (keydown.enter)="onNameEnter($event)"
              (keydown.escape)="cancelAddMode()"
            >
            </app-input>
            <app-input
              #amountInput
              label="Amount"
              class="col"
              type="text"
              [isCurrency]="true"
              [inputFormControl]="newItemFormGroup | formGet : 'amount'"
              [readonly]="mode | inputReadonly"
              (keydown.enter)="onAmountEnter($event)"
              (keydown.escape)="cancelAddMode()"
            >
            </app-input>

            @if (!selectedGroup?.groupReceiptSettings?.hideItemCategories) {
              <app-category-autocomplete
                #categoryInput
                [categories]="categories"
                [inputFormControl]="newItemFormGroup | formGet : 'categories'"
                [readonly]="mode | inputReadonly"
                (keydown.enter)="onCategoryEnter($event)"
                (keydown.escape)="cancelAddMode()"
              ></app-category-autocomplete>
            }

            @if (!selectedGroup?.groupReceiptSettings?.hideItemTags) {
              <app-tag-autocomplete
                #tagInput
                [tags]="tags"
                [inputFormControl]="newItemFormGroup | formGet : 'tags'"
                [readonly]="mode | inputReadonly"
                (keydown.enter)="onTagEnter($event)"
                (keydown.escape)="cancelAddMode()"
              ></app-tag-autocomplete>
            }
          </div>
          <div class="add-form-actions">
            <app-button
              matButtonType="basic"
              [buttonText]="'Add Item'"
              color="primary"
              (clicked)="submitAndContinue()"
              [disabled]="!newItemFormGroup.valid"
            ></app-button>
            <app-button
              matButtonType="basic"
              [buttonText]="'Add & Done'"
              color="accent"
              (clicked)="submitAndFinish()"
              [disabled]="!newItemFormGroup.valid"
            ></app-button>
            <app-button
              matButtonType="basic"
              [buttonText]="'Cancel'"
              (clicked)="cancelAddMode()"
            ></app-button>
          </div>
        </div>
      </app-card>
    </div>
  }

  <!-- No Items Message -->
  @if (items.length === 0 && mode === formMode.view && !isAdding) {
    <div class="no-items-message">No items for this receipt</div>
  }
  
  <!-- Items List -->
  @if (items.length > 0 || isAdding) {
    <mat-accordion multi>
      <mat-expansion-panel #itemsExpansionPanel>
        <mat-expansion-panel-header class="sticky-accordion-header">
          <mat-panel-title>
            Items ({{ items.length }})
          </mat-panel-title>
          <mat-panel-description>
            <div class="accordion-header-content">
              <span class="header-total">
                Total: {{ getTotalAmount() | customCurrency }}
              </span>
              @if (originalReceipt?.groupId | groupRole : groupRole.Editor) {
                <app-add-button
                  tooltip="Add Item (Ctrl+I)"
                  [disabled]="mode === formMode.view"
                  (clicked)="startAddMode()"
                ></app-add-button>
              }
            </div>
          </mat-panel-description>
        </mat-expansion-panel-header>
        
        <div *ngFor="let itemData of items; let i = index" class="item-row">
          <app-card cardStyle="mb-2">
            <div content class="d-flex flex-column item-form-container">
              <div class="d-flex justify-content-end">
                @if (!(mode | inputReadonly)) {
                  <app-delete-button
                    tooltip="Remove Item"
                    [disabled]="
                      !(originalReceipt?.groupId | groupRole : groupRole.Editor)
                    "
                    (clicked)="removeItem(itemData)"
                  ></app-delete-button>
                }
              </div>
              <div class="row g-0">
                <app-input
                  class="col"
                  #nameField
                  label="Name"
                  [inputId]="'name-' + i"
                  [inputFormControl]="
                    form | formGet : 'receiptItems.' + itemData.arrayIndex + '.name'
                  "
                  [readonly]="mode | inputReadonly"
                  (inputBlur)="addInlineItemOnBlur(i)"
                >
                </app-input>
                <app-input
                  class="col"
                  label="Amount"
                  [isCurrency]="true"
                  [inputFormControl]="
                    form | formGet : 'receiptItems.' + itemData.arrayIndex + '.amount'
                  "
                  [readonly]="mode | inputReadonly"
                  (inputBlur)="addInlineItemOnBlur(i)"
                >
                </app-input>
                @if (!selectedGroup?.groupReceiptSettings?.hideItemCategories) {
                  <app-category-autocomplete
                    [categories]="categories"
                    [inputFormControl]="form | formGet : 'receiptItems.' + itemData.arrayIndex + '.categories'"
                    [readonly]="mode | inputReadonly"
                  ></app-category-autocomplete>
                }

                @if (!selectedGroup?.groupReceiptSettings?.hideItemTags) {
                  <app-tag-autocomplete
                    [tags]="tags"
                    [inputFormControl]="form | formGet : 'receiptItems.' + itemData.arrayIndex + '.tags'"
                    [readonly]="mode | inputReadonly"
                  ></app-tag-autocomplete>
                }
              </div>
            </div>
          </app-card>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  }
</div>