<mat-card>
  <mat-card-header>
    <mat-card-title><strong>Comments</strong></mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <app-textarea
      label="Comment"
      placeholder="Leave a comment"
      [inputFormControl]="newCommentFormControl"
    ></app-textarea>
    <ng-container
      *ngIf="mode === formMode.add || mode === formMode.view"
      [ngTemplateOutlet]="add"
    ></ng-container>
    <div
      *ngFor="let comment of commentsArray | topLevelComment; let index = index"
    >
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex mb-2 align-items-center">
          <app-avatar
            class="me-2"
            [user]="comment?.value?.userId?.toString() ?? '' | user"
          ></app-avatar>
          <div class="d-flex flex-column">
            <div>
              <strong>
                {{
                  (comment?.value?.userId?.toString() ?? "" | user)?.displayName
                }}
              </strong>
              <small *ngIf="comments[index]?.updatedAt"
                ><span> - </span
                >{{ comments[index]?.updatedAt | date : "medium" }}</small
              >
            </div>
            <span class="mb-2">{{ comment?.value?.comment }}</span>
            <div class="d-flex">
              <ng-container
                *ngIf="
                  comment?.value?.replies?.length &&
                  comment.value.replies.length > 0
                "
              >
                <app-button
                  class="reply-button"
                  matButtonType="basic"
                  buttonText="View Replies"
                ></app-button>
              </ng-container>
              <app-button
                *ngIf="mode === formMode.view"
                class="reply-button"
                matButtonType="basic"
                buttonText="Reply"
                (clicked)="replyClicked(comment, index)"
              ></app-button>
            </div>
          </div>
        </div>
        <ng-container
          *ngIf="
            comment?.value?.userId?.toString() === (loggedInUserId | async)
          "
        >
          <app-delete-button
            (clicked)="deleteComment(index)"
          ></app-delete-button>
        </ng-container>
      </div>
      <ng-container *ngIf="comment?.value?.isReplyOpen">
        <app-textarea
          label="Comment"
          placeholder="Leave a reply"
          [inputFormControl]="
            $any(comment.get('replies')) | formArrayLast | formGet : 'comment'
          "
        ></app-textarea>
        <div class="d-flex justify-content-end">
          <app-submit-button
            (clicked)="replySaveButtonClicked(comment, index)"
          ></app-submit-button>
          <app-cancel-button
            (clicked)="replyCancelButtonClicked(comment)"
          ></app-cancel-button>
        </div>
      </ng-container>
    </div>
  </mat-card-content>
</mat-card>

<ng-template #add>
  <div class="d-flex justify-content-end">
    <app-button buttonText="Add Comment" (clicked)="addComment()"></app-button>
  </div>
</ng-template>
