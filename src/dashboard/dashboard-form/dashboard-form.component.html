<app-dialog [headerText]="headerText">
  <form [formGroup]="form" (ngSubmit)="submit()">
    <div class="d-flex flex-column">
      <div class="mb-2">
        <app-input
          label="Dashboard Name"
          [inputFormControl]="form | formGet : 'name'"
        ></app-input>
      </div>
      <app-form-section headerText="Widgets" [indent]="false">
        <mat-list>
          @for (widget of widgets.controls; let i = $index; track widget.value) {
            @if ((widgetOpen | async) === i) {
              <ng-template
                [ngTemplateOutlet]="widgetEdit"
                [ngTemplateOutletContext]="{ i: i }"
              ></ng-template>
            } @else {
              <mat-list-item>
                <span matListItemTitle>{{ widget.value.name ?? "Group Summary" }}</span>
                <span matListItemLine>{{ widget.value.widgetType | widgetType }}</span>
                <div matListItemMeta class="d-flex align-items-center">
                  <app-edit-button
                    [disabled]="(widgetOpen | async) !== undefined"
                    (clicked)="openWidget(i)"
                  ></app-edit-button>
                  <app-delete-button
                    [disabled]="(widgetOpen | async) !== undefined"
                    (clicked)="removeFilter(i)"
                  >
                  </app-delete-button>
                </div>
              </mat-list-item>
            }
          }
        </mat-list>
      </app-form-section>
    </div>
    <app-dialog-footer
      [disableWhenProgressBarIsShown]="true"
      (cancelClicked)="cancelButtonClicked()"
    ></app-dialog-footer>
  </form>
</app-dialog>

<ng-template #filterFooter></ng-template>
<ng-template #filterPreview let-index="index">
  {{ originalWidgets?.[index]?.name }}
</ng-template>

<ng-template #widgetEdit let-i="i">
  <app-card>
    <ng-container header>
      <div class="mb-2">
        Edit Widget
      </div>
    </ng-container>
    <ng-container content>
      <app-input
        label="Widget Name"
        [inputFormControl]="
                      form | formGet : 'widgets.' + i + '.name'
                    "
      ></app-input>
      <app-select
        label="Widget Type"
        optionValueKey="value"
        optionDisplayKey="displayValue"
        [inputFormControl]="
                      form | formGet : 'widgets.' + i + '.widgetType'
                    "
        [options]="widgetTypeOptions"
      ></app-select>
      <ng-container
        [ngSwitch]="widgets.controls[i].value.widgetType"
      >
        <ng-container *ngSwitchCase="WidgetType.GroupSummary">
        </ng-container>
        <ng-container *ngSwitchCase="WidgetType.FilteredReceipts">
          <app-receipt-filter
            class="w-100"
            [filter]="$any(dashboard?.widgets?.[i]?.configuration)"
            [footerTemplate]="filterFooter"
            [isOpen]="(widgetOpen | async) === i"
            [inDialog]="false"
            [previewTemplate]="filterPreview"
            [previewTemplateContext]="{ index: i }"
            (formInitialized)="addFilterToWidget($event, i)"
          ></app-receipt-filter>
        </ng-container>
      </ng-container>
      <app-dialog-footer
        submitButtonTooltip="Done"
        (submitClicked)="submitWidget(i)"
        (cancelClicked)="cancelWidgetEdit()"
      ></app-dialog-footer>
    </ng-container>
  </app-card>
</ng-template>
